<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جارٍ الفحص... | Ethical Scanner v6.0</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Cairo & JetBrains Mono -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-color: #2c3e50;
            --border-color: rgba(0,0,0,0.1);
            --primary-gradient: linear-gradient(90deg, #2980b9, #8e44ad);
            --log-bg: #e9ecef;
            --log-text: #343a40;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        html[data-theme='dark'] {
            --bg-color: #1a1a1d;
            --card-bg: rgba(40, 40, 48, 0.85);
            --text-color: #e0e0e0;
            --border-color: rgba(255,255,255,0.15);
            --log-bg: #2b2b2b;
            --log-text: #d4d4d4;
            --primary-gradient: linear-gradient(90deg, #5dade2, #af7ac5);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .scanner-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 900px;
            padding: 3rem;
        }
        .progress {
            height: 25px; border-radius: 50px;
            background-color: var(--log-bg);
            padding: 4px;
        }
        .progress-bar {
            background: var(--primary-gradient);
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
        }
        .log-box {
            background-color: var(--log-bg);
            color: var(--log-text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            height: 400px;
            overflow-y: auto;
            border-radius: 0.5rem;
            padding: 1.5rem;
            white-space: pre-wrap;
            direction: ltr; text-align: left;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        #current-phase-icon {
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="scanner-card text-center">
        <h2 class="fw-bold mb-3">محرك الفحص يعمل</h2>
        <p class="text-muted fs-5 mb-4">يتم تنفيذ سلسلة هجمات سياقية على الهدف: <code style="color:var(--primary-color)">{{ target_url }}</code></p>

        <div class="progress my-4">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>

        <div class="d-flex justify-content-center align-items-center mt-3 fs-5">
            <i id="current-phase-icon" class="fas fa-cog fa-spin me-2"></i>
            <span id="current-phase-text">تهيئة</span><span class="mx-2">|</span><span id="progress-message" class="text-muted">...</span>
        </div>

        <h6 class="mt-4 mb-2 text-end">سجل العمليات المباشر (Terminal)</h6>
        <div id="log-container" class="log-box"></div>
    </div>

    <script>
        const scanId = "{{ scan_id }}";
        const logContainer = document.getElementById('log-container');
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        const phaseText = document.getElementById('current-phase-text');
        const phaseIcon = document.getElementById('current-phase-icon');
        let currentLogLength = 0;

        // Apply saved theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        function getPhase(progress) {
            if (progress < 15) return { text: "الاستطلاع", icon: "fas fa-binoculars" };
            if (progress < 30) return { text: "الاستكشاف (Crawling)", icon: "fas fa-sitemap" };
            if (progress < 75) return { text: "الهجوم والتحليل", icon: "fas fa-crosshairs" };
            if (progress < 95) return { text: "التحقق من النتائج", icon: "fas fa-search-plus" };
            return { text: "الإنهاء", icon: "fas fa-flag-checkered" };
        }

        function fetchStatus() {
            fetch(`/scan_status/${scanId}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress || 0;
                progressBar.style.width = progress + '%';
                progressBar.innerText = progress + '%';

                const phase = getPhase(progress);
                phaseText.innerText = phase.text;
                phaseIcon.className = `${phase.icon} me-2`;
                if(progress < 95 && !phaseIcon.classList.contains('fa-spin')) {
                     phaseIcon.classList.add('fa-spin');
                } else if(progress >= 95) {
                     phaseIcon.classList.remove('fa-spin');
                }

                const latestLog = data.log.length > 0 ? data.log[data.log.length - 1].replace(/\[.*?\]\s/,'') : 'جاري البدء...';
                progressMessage.innerText = latestLog;

                if (data.log.length > currentLogLength) {
                    const newLogs = data.log.slice(currentLogLength);
                    newLogs.forEach(line => { logContainer.innerHTML += `<div>${line}</div>`; });
                    logContainer.scrollTop = logContainer.scrollHeight;
                    currentLogLength = data.log.length;
                }

                if (data.status === 'completed') {
                    progressMessage.innerText = 'اكتمل! جاري إعداد التقرير النهائي...';
                    window.location.href = data.results_url;
                } else if (data.status === 'error') {
                    progressMessage.innerText = 'حدث خطأ. توقف الفحص.';
                    progressBar.classList.add('bg-danger');
                    phaseIcon.className = "fas fa-exclamation-triangle me-2 text-danger";
                    phaseIcon.classList.remove('fa-spin');
                } else {
                    setTimeout(fetchStatus, 1500);
                }
            })
            .catch(err => {
                console.error("Fetch Error:", err);
                progressMessage.innerText = 'فشل الاتصال بالخادم.';
                progressBar.classList.add('bg-danger');
                phaseIcon.className = "fas fa-wifi-slash me-2 text-danger";
                phaseIcon.classList.remove('fa-spin');

            });
        }
        document.addEventListener('DOMContentLoaded', fetchStatus);
    </script>
</body>
</html>